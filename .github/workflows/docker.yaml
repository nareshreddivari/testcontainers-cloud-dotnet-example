name: Testcontainers Cloud Workflow

on:
  push:
    branches:
      - main

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set Up .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: 7.0.x

      - name: Download and install Testcontainers Cloud
        run: |
          curl -fsSL https://download.testcontainers.cloud/testcontainers-cloud-linux -o install-tc.sh
          chmod +x install-tc.sh
          ./install-tc.sh



      - name: Start Testcontainers Cloud Agent
        run: |
          testcontainers-cloud &  # Start agent in background
          sleep 5  # Wait for the agent to initialize
          testcontainers-cloud --status || echo "Testcontainers Cloud agent failed to start!"

      - name: Set Docker Context to Testcontainers Cloud
        run: |
          docker context use tcc || echo "Testcontainers Cloud context not available"
          docker context ls

      - name: List Running Docker Containers
        run: docker ps -a

      - name: Run Tests with Testcontainers Cloud
        run: |
          cd tests
          dotnet test --logger:"console;verbosity=detailed"
